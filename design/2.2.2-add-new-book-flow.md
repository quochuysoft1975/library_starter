# 2.2.2 Add New Book Flow

## Feature: Add New Book
**Actor:** Librarian  
**Dependencies:** 2.1.2 (Login), 2.2.1 (Category Management)

## Flowchart

```mermaid
flowchart TD
    Start([Librarian logged in]) --> ClickAdd[Click 'Thêm Sách Mới']
    ClickAdd --> ShowForm[Display add book form]
    ShowForm --> FillForm[Librarian enters:<br/>- Title<br/>- Author<br/>- Publish Year<br/>- ISBN<br/>- Category<br/>- Description<br/>- Quantity]
    
    FillForm --> Validate{Validate all fields}
    
    Validate -->|Title empty or > 100 chars| ErrorTitle[Show error: Title validation failed]
    ErrorTitle --> FillForm
    
    Validate -->|Author empty or > 100 chars| ErrorAuthor[Show error: Author validation failed]
    ErrorAuthor --> FillForm
    
    Validate -->|Invalid ISBN format| ErrorISBN[Show error: Invalid ISBN format]
    ErrorISBN --> FillForm
    
    Validate -->|ISBN already exists| ErrorISBNExists[Show error: ISBN already exists]
    ErrorISBNExists --> FillForm
    
    Validate -->|Quantity <= 0 or not number| ErrorQuantity[Show error: Quantity must be > 0]
    ErrorQuantity --> FillForm
    
    Validate -->|Publish year < 1900 or > current| ErrorYear[Show error: Invalid publish year]
    ErrorYear --> FillForm
    
    Validate -->|Category not selected| ErrorCategory[Show error: Category required]
    ErrorCategory --> FillForm
    
    Validate -->|Description empty or > 255 chars| ErrorDesc[Show error: Description validation failed]
    ErrorDesc --> FillForm
    
    Validate -->|All valid| SubmitForm[Submit form]
    SubmitForm --> CheckISBN{ISBN exists?}
    
    CheckISBN -->|Yes| ErrorISBNExists
    CheckISBN -->|No| CreateBook[Create book with status 'Có sẵn']
    CreateBook --> SaveDB{Save to database}
    
    SaveDB -->|Success| ShowSuccess[Show 'Thêm sách thành công']
    SaveDB -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> SubmitForm
    
    ShowSuccess --> Redirect{Redirect option?}
    
    Redirect -->|View Book| ViewBook[Redirect to book details]
    Redirect -->|Book List| BookList[Redirect to book list]
    Redirect -->|Add Another| ResetForm[Reset form, stay on page]
    
    ViewBook --> EndView([Book Details])
    BookList --> EndList([Book List])
    ResetForm --> ShowForm
    
    FillForm --> Cancel[Cancel]
    Cancel --> BookList
    
    style Start fill:#e1f5ff
    style EndView fill:#c8e6c9
    style EndList fill:#c8e6c9
    style ShowSuccess fill:#c8e6c9
    style ErrorTitle fill:#ffcdd2
    style ErrorAuthor fill:#ffcdd2
    style ErrorISBN fill:#ffcdd2
    style ErrorISBNExists fill:#ffcdd2
    style ErrorQuantity fill:#ffcdd2
    style ErrorYear fill:#ffcdd2
    style ErrorCategory fill:#ffcdd2
    style ErrorDesc fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
```

## Validation Rules
- **Title:** Not empty, max 100 characters
- **Author:** Not empty, max 100 characters
- **ISBN:** Valid ISBN-10 or ISBN-13 format (if provided)
- **Quantity:** Must be > 0, numeric
- **Publish Year:** Valid year (1900 - current year)
- **Category:** Must be selected
- **Description:** Not empty, max 255 characters

## Error Cases
- Title validation failed
- Author validation failed
- Invalid ISBN format
- ISBN already exists
- Quantity validation failed
- Invalid publish year
- Category not selected
- Description validation failed
- Network error

