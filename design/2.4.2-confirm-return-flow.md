# 2.4.2 Confirm Return Flow

## Feature: Confirm Return
**Actor:** Librarian  
**Dependencies:** 2.1.2 (Login), 2.4.1 (Return Request), 2.5.1 (Penalty Type Management)

## Flowchart

```mermaid
flowchart TD
    Start([Librarian logged in]) --> NavigateManage[Navigate to 'Quản lý mượn trả']
    NavigateManage --> SelectTab[Select tab 'Chờ xác nhận trả']
    SelectTab --> LoadReturns[Load pending return requests]
    LoadReturns --> DisplayList[Display list of pending returns]
    
    DisplayList --> ReceiveBook[Librarian receives physical book from reader]
    ReceiveBook --> ClickConfirm[Click 'Xác nhận trả']
    ClickConfirm --> SelectCondition{Select book condition}
    
    SelectCondition -->|Bình thường| Normal[Select 'Bình thường']
    SelectCondition -->|Hư hỏng| Damaged[Select 'Hư hỏng']
    SelectCondition -->|Mất| Lost[Select 'Mất']
    
    Normal --> UpdateNormal[Update borrow status to 'Đã trả']
    UpdateNormal --> IncreaseAvailable[Increase book available quantity]
    IncreaseAvailable --> DecreaseBorrowed[Decrease book borrowed quantity]
    DecreaseBorrowed --> SaveNormal{Save to database}
    
    SaveNormal -->|Success| ShowNormalSuccess[Show success message]
    SaveNormal -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> UpdateNormal
    
    ShowNormalSuccess --> RefreshList[Refresh return request list]
    RefreshList --> DisplayList
    
    Damaged --> SelectPenaltyType[Select penalty type]
    SelectPenaltyType --> EnterNotes[Enter notes - required]
    EnterNotes --> ValidateDamaged{Validate input}
    
    ValidateDamaged -->|Penalty type not selected| ErrorPenalty[Show error: Penalty type required]
    ErrorPenalty --> SelectPenaltyType
    
    ValidateDamaged -->|Notes empty| ErrorNotes[Show error: Notes required]
    ErrorNotes --> EnterNotes
    
    ValidateDamaged -->|Notes > 500 chars| ErrorNotesLength[Show error: Notes too long]
    ErrorNotesLength --> EnterNotes
    
    ValidateDamaged -->|All valid| CheckOverdue{Return overdue?}
    
    CheckOverdue -->|Yes| CreateLatePenalty[Create 'Trả muộn' penalty]
    CheckOverdue -->|No| SkipLatePenalty[Skip late penalty]
    
    CreateLatePenalty --> CreateDamagePenalty[Create 'Hư hỏng' penalty]
    SkipLatePenalty --> CreateDamagePenalty
    
    CreateDamagePenalty --> UpdateDamaged[Update borrow status to 'Đã trả']
    UpdateDamaged --> UpdateBookStatus[Update book status to 'DAMAGED']
    UpdateBookStatus --> SaveDamaged{Save to database}
    
    SaveDamaged -->|Success| ShowDamagedSuccess[Show success message]
    SaveDamaged -->|Network Error| ErrorNetwork
    
    ShowDamagedSuccess --> RefreshList
    
    Lost --> SelectPenaltyTypeLost[Select penalty type]
    SelectPenaltyTypeLost --> EnterNotesLost[Enter notes - required]
    EnterNotesLost --> ValidateLost{Validate input}
    
    ValidateLost -->|Penalty type not selected| ErrorPenalty
    ValidateLost -->|Notes empty| ErrorNotes
    ValidateLost -->|Notes > 500 chars| ErrorNotesLength
    ValidateLost -->|All valid| CreateLostPenalty[Create 'Mất' penalty]
    
    CreateLostPenalty --> UpdateLost[Update borrow status to 'Đã trả']
    UpdateLost --> UpdateBookStatusLost[Update book status to 'LOST']
    UpdateBookStatusLost --> DecreaseTotal[Decrease book total quantity]
    DecreaseTotal --> SaveLost{Save to database}
    
    SaveLost -->|Success| ShowLostSuccess[Show success message]
    SaveLost -->|Network Error| ErrorNetwork
    
    ShowLostSuccess --> RefreshList
    
    ClickConfirm --> CheckProcessed{Return already processed?}
    CheckProcessed -->|Yes| ErrorProcessed[Show error: 'Yêu cầu trả sách đã được xử lý']
    ErrorProcessed --> DisplayList
    
    EnterNotes --> CancelConfirm[Cancel confirmation]
    CancelConfirm --> DisplayList
    
    EnterNotesLost --> CancelConfirm
    
    style Start fill:#e1f5ff
    style DisplayList fill:#c8e6c9
    style ShowNormalSuccess fill:#c8e6c9
    style ShowDamagedSuccess fill:#c8e6c9
    style ShowLostSuccess fill:#c8e6c9
    style ErrorPenalty fill:#ffcdd2
    style ErrorNotes fill:#ffcdd2
    style ErrorNotesLength fill:#ffcdd2
    style ErrorProcessed fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
```

## Validation Rules
- **Book condition:** Required, must be one of: Normal, Damaged, Lost
- **Penalty type:** Required when condition is Damaged or Lost
- **Notes:** Required when condition is Damaged or Lost, max 500 characters

## Error Cases
- Penalty type not selected (for damaged/lost)
- Notes is empty (for damaged/lost)
- Notes > 500 characters
- Book condition not selected
- Network error
- Return request already processed

## Special Cases
- **Damaged + Overdue:** Creates both "Hư hỏng" and "Trả muộn" penalties
- **Lost:** Decreases total book quantity

