# 2.4.1 Return Request Flow

## Feature: Return Request
**Actor:** Reader  
**Dependencies:** 2.1.2 (Login), 2.3.1 (Borrow Book)

## Flowchart

```mermaid
flowchart TD
    Start([Reader logged in]) --> NavigateHistory[Navigate to 'Lịch sử mượn sách']
    NavigateHistory --> LoadBorrows[Load currently borrowed books]
    LoadBorrows --> DisplayBorrows[Display list of borrowed books]
    
    DisplayBorrows --> ClickReturn[Click 'Xin trả sách' on a book]
    ClickReturn --> CheckPending{Already has pending return?}
    
    CheckPending -->|Yes| ErrorPending[Show error: 'Đã có yêu cầu trả sách đang chờ xác nhận']
    ErrorPending --> DisplayBorrows
    
    CheckPending -->|No| CheckStatus{Book status?}
    
    CheckStatus -->|Not 'Đang mượn'| ErrorStatus[Show error: 'Sách không ở trạng thái đang mượn']
    ErrorStatus --> DisplayBorrows
    
    CheckStatus -->|'Đang mượn'| ShowConfirm[Show confirmation modal]
    ShowConfirm --> UserConfirm{User confirms?}
    
    UserConfirm -->|No| CancelReturn[Cancel return request]
    CancelReturn --> DisplayBorrows
    
    UserConfirm -->|Yes| CreateReturn[Create return request<br/>Status: 'Chờ xác nhận']
    CreateReturn --> SaveDB{Save to database}
    
    SaveDB -->|Success| ShowSuccess[Show success message]
    SaveDB -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> CreateReturn
    
    ShowSuccess --> RefreshHistory[Refresh borrow history]
    RefreshHistory --> DisplayBorrows
    
    DisplayBorrows --> AnotherBook{Request return for another book?}
    AnotherBook -->|Yes| ClickReturn
    AnotherBook -->|No| End([Stay on history page])
    
    LoadBorrows --> CheckBook{Book exists?}
    CheckBook -->|No| ErrorNotFound[Show error: 'Sách không tồn tại']
    ErrorNotFound --> DisplayBorrows
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style DisplayBorrows fill:#c8e6c9
    style ShowSuccess fill:#c8e6c9
    style ErrorPending fill:#ffcdd2
    style ErrorStatus fill:#ffcdd2
    style ErrorNotFound fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
```

## Validation Rules
- Only one pending return request per borrow
- Book must be in "Đang mượn" (Approved) status

## Error Cases
- Book already has pending return request
- Book not found
- Book not in correct status
- Network error

## Note
- Reader needs to bring physical book to library for librarian confirmation

