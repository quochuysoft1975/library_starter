# 2.3.3 View Borrow History Flow

## Feature: View Borrow History
**Actor:** Reader  
**Dependencies:** 2.1.2 (Login), 2.3.1 (Borrow Book)

## Flowchart

```mermaid
flowchart TD
    Start([Reader logged in]) --> NavigateHistory[Navigate to 'Lịch sử mượn sách']
    NavigateHistory --> LoadHistory[Load borrow history]
    LoadHistory --> DisplayHistory[Display borrow history:<br/>- Currently borrowed: Title, Author,<br/>  Borrow Date, Due Date, Days Remaining<br/>- Returned: Title, Borrow Date, Return Date<br/>- Rejected: Title, Author, Rejection Reason]
    
    DisplayHistory --> ShowStatus[Show status:<br/>'Chờ xác nhận', 'Đang mượn',<br/>'Quá hạn', 'Đã trả', 'Bị từ chối']
    
    ShowStatus --> ReaderAction{Reader action?}
    
    ReaderAction -->|Filter by Status| SelectFilter[Select status filter]
    ReaderAction -->|Request Return| ClickReturn[Click 'Xin trả sách']
    ReaderAction -->|Extend Borrow| ClickExtend[Click 'Gia hạn']
    ReaderAction -->|View Rejection Reason| ViewReason[View detailed rejection reason]
    
    SelectFilter --> ApplyFilter[Filter borrow history by status]
    ApplyFilter --> UpdateDisplay[Update displayed list]
    UpdateDisplay --> DisplayHistory
    
    SelectFilter --> ClearFilter[Clear filter]
    ClearFilter --> ResetDisplay[Reset to all borrows]
    ResetDisplay --> DisplayHistory
    
    ClickReturn --> CheckPending{Already has pending return?}
    
    CheckPending -->|Yes| ErrorPending[Show error: 'Đã có yêu cầu trả sách đang chờ xác nhận']
    ErrorPending --> DisplayHistory
    
    CheckPending -->|No| CreateReturn[Create return request<br/>Status: 'Chờ xác nhận']
    CreateReturn --> SaveReturn{Save to database}
    
    SaveReturn -->|Success| ShowReturnSuccess[Show success message]
    SaveReturn -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> CreateReturn
    
    ShowReturnSuccess --> RefreshHistory[Refresh borrow history]
    RefreshHistory --> DisplayHistory
    
    ClickExtend --> CheckExtendConditions{Can extend?}
    
    CheckExtendConditions -->|Overdue| ErrorOverdue[Show 'Quá hạn'<br/>Disable extend button]
    ErrorOverdue --> DisplayHistory
    
    CheckExtendConditions -->|Already extended| ErrorExtended[Show 'Đã gia hạn'<br/>Disable extend button]
    ErrorExtended --> DisplayHistory
    
    CheckExtendConditions -->|Can extend| ExtendDueDate[Extend due date by 7 days]
    ExtendDueDate --> MarkExtended[Mark borrow as extended]
    MarkExtended --> SaveExtend{Save to database}
    
    SaveExtend -->|Success| ShowExtendSuccess[Show success message]
    SaveExtend -->|Network Error| ErrorNetwork
    
    ShowExtendSuccess --> RefreshHistory
    
    ViewReason --> ShowReasonModal[Show rejection reason in modal]
    ShowReasonModal --> CloseModal[Close modal]
    CloseModal --> DisplayHistory
    
    LoadHistory --> ErrorNetwork{Network error?}
    ErrorNetwork -->|Yes| ShowError[Show error message, allow retry]
    ShowError --> LoadHistory
    
    style Start fill:#e1f5ff
    style DisplayHistory fill:#c8e6c9
    style ShowReturnSuccess fill:#c8e6c9
    style ShowExtendSuccess fill:#c8e6c9
    style ErrorPending fill:#ffcdd2
    style ErrorOverdue fill:#ffcdd2
    style ErrorExtended fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
    style ShowError fill:#ffcdd2
```

## Validation Rules
- Only one pending return request per borrow
- Extend only if: not overdue, not already extended (max 1 time)
- Extend duration: +7 days

## Error Cases
- Book already has pending return request
- Book is overdue (cannot extend)
- Book already extended (cannot extend again)
- Network error

