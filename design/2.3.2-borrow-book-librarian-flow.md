# 2.3.2 Borrow Book - Librarian Flow

## Feature: Borrow Book Approval - Librarian
**Actor:** Librarian  
**Dependencies:** 2.1.2 (Login), 2.3.1 (Borrow Book - Reader)

## Flowchart

```mermaid
flowchart TD
    Start([Librarian logged in]) --> NavigateManage[Navigate to 'Quản lý mượn trả']
    NavigateManage --> LoadRequests[Load pending borrow requests]
    LoadRequests --> DisplayList[Display list of pending requests]
    
    DisplayList --> LibrarianAction{Librarian action?}
    
    LibrarianAction -->|Approve| ClickApprove[Click 'Xác nhận']
    LibrarianAction -->|Reject| ClickReject[Click 'Từ chối']
    LibrarianAction -->|Filter| FilterStatus[Filter by status]
    
    ClickApprove --> CheckAvailability{Book still available?}
    
    CheckAvailability -->|No| ErrorNotAvailable[Show error: 'Sách không còn sẵn'<br/>Allow rejection only]
    ErrorNotAvailable --> DisplayList
    
    CheckAvailability -->|Yes| UpdateStatus[Update borrow status to 'Đã mượn']
    UpdateStatus --> DecreaseAvailable[Decrease book available quantity]
    DecreaseAvailable --> IncreaseBorrowed[Increase book borrowed quantity]
    IncreaseBorrowed --> SaveApprove{Save to database}
    
    SaveApprove -->|Success| ShowApproveSuccess[Show success message]
    SaveApprove -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> UpdateStatus
    
    ShowApproveSuccess --> RefreshList[Refresh request list]
    RefreshList --> DisplayList
    
    ClickReject --> ShowRejectForm[Show rejection form]
    ShowRejectForm --> EnterReason[Enter rejection reason]
    EnterReason --> ValidateReason{Reason not empty?}
    
    ValidateReason -->|Empty| ErrorEmptyReason[Show error: Reason required]
    ErrorEmptyReason --> EnterReason
    
    ValidateReason -->|Valid| UpdateReject[Update borrow status to 'Bị từ chối']
    UpdateReject --> SaveReason[Save rejection reason]
    SaveReason --> SaveReject{Save to database}
    
    SaveReject -->|Success| ShowRejectSuccess[Show success message]
    SaveReject -->|Network Error| ErrorNetwork
    
    ShowRejectSuccess --> RefreshList
    
    EnterReason --> CancelReject[Cancel rejection]
    CancelReject --> DisplayList
    
    FilterStatus --> UpdateFilter[Update displayed list]
    UpdateFilter --> DisplayList
    
    LoadRequests --> CheckProcessed{Request already processed?}
    CheckProcessed -->|Yes| ErrorProcessed[Show error: 'Đơn mượn đã được xử lý']
    ErrorProcessed --> DisplayList
    CheckProcessed -->|No| DisplayList
    
    style Start fill:#e1f5ff
    style DisplayList fill:#c8e6c9
    style ShowApproveSuccess fill:#c8e6c9
    style ShowRejectSuccess fill:#c8e6c9
    style ErrorNotAvailable fill:#ffcdd2
    style ErrorEmptyReason fill:#ffcdd2
    style ErrorProcessed fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
```

## Validation Rules
- Rejection reason: Not empty, required when rejecting

## Error Cases
- Rejection reason is empty
- Book no longer available (allow rejection only)
- Network error
- Request already processed

