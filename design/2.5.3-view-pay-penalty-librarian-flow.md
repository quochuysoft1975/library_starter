# 2.5.3 View & Pay Penalty - Librarian Flow

## Feature: View & Pay Penalty Confirmation - Librarian
**Actor:** Librarian  
**Dependencies:** 2.1.2 (Login), 2.5.2 (View & Pay Penalty - Reader)

## Flowchart

```mermaid
flowchart TD
    Start([Librarian logged in]) --> NavigatePenalty[Navigate to Penalty Management]
    NavigatePenalty --> LoadPenalties[Load penalties with status 'Chờ xác nhận']
    LoadPenalties --> DisplayList[Display list of pending penalties]
    
    DisplayList --> LibrarianAction{Librarian action?}
    
    LibrarianAction -->|View Details| ClickDetails[Click on penalty]
    LibrarianAction -->|Confirm Payment| ClickConfirm[Click 'Đã thanh toán']
    LibrarianAction -->|Reject Payment| ClickReject[Click 'Từ chối']
    LibrarianAction -->|View All| ViewAll[View all penalties with filters]
    
    ClickDetails --> ShowDetails[Show detailed penalty information]
    ShowDetails --> VerifyAmount[Verify payment amount matches]
    ShowDetails --> CloseDetails[Close details]
    CloseDetails --> DisplayList
    
    ClickConfirm --> VerifyPayment{Payment amount matches?}
    
    VerifyPayment -->|Yes| UpdatePaid[Update penalty status to 'Đã thanh toán']
    UpdatePaid --> RecordDate[Record confirmation date]
    RecordDate --> SaveConfirm{Save to database}
    
    SaveConfirm -->|Success| ShowConfirmSuccess[Show success message]
    SaveConfirm -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> UpdatePaid
    
    ShowConfirmSuccess --> RefreshList[Refresh penalty list]
    RefreshList --> DisplayList
    
    ClickReject --> VerifyReject{Payment amount doesn't match?}
    
    VerifyReject -->|Yes| ShowRejectForm[Show rejection form]
    VerifyReject -->|No| ErrorReject[Show error: Cannot reject if amount matches]
    ErrorReject --> DisplayList
    
    ShowRejectForm --> EnterReason[Enter rejection reason - required]
    EnterReason --> ValidateReason{Reason not empty?}
    
    ValidateReason -->|Empty| ErrorEmptyReason[Show error: Rejection reason required]
    ErrorEmptyReason --> EnterReason
    
    ValidateReason -->|Valid| UpdateReject[Update penalty status to 'Từ chối']
    UpdateReject --> SaveReason[Save rejection reason]
    SaveReason --> SaveReject{Save to database}
    
    SaveReject -->|Success| ShowRejectSuccess[Show success message]
    SaveReject -->|Network Error| ErrorNetwork
    
    ShowRejectSuccess --> RefreshList
    
    EnterReason --> CancelReject[Cancel rejection]
    CancelReject --> DisplayList
    
    ViewAll --> ShowAllPenalties[Show all penalties with filters]
    ShowAllPenalties --> ApplyFilters[Apply filters by status, date, etc.]
    ApplyFilters --> DisplayList
    
    LoadPenalties --> CheckProcessed{Penalty already processed?}
    CheckProcessed -->|Yes| ErrorProcessed[Show error: 'Khoản phạt đã được xử lý']
    ErrorProcessed --> DisplayList
    CheckProcessed -->|No| DisplayList
    
    style Start fill:#e1f5ff
    style DisplayList fill:#c8e6c9
    style ShowConfirmSuccess fill:#c8e6c9
    style ShowRejectSuccess fill:#c8e6c9
    style ErrorReject fill:#ffcdd2
    style ErrorEmptyReason fill:#ffcdd2
    style ErrorProcessed fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
```

## Validation Rules
- Rejection reason: Required when rejecting, not empty

## Error Cases
- Rejection reason is empty
- Penalty already processed
- Network error

## Process
- Librarian verifies payment amount
- If matches: Confirm payment
- If doesn't match: Reject with reason

