# 2.5.2 View & Pay Penalty - Reader Flow

## Feature: View & Pay Penalty - Reader
**Actor:** Reader  
**Dependencies:** 2.1.2 (Login), 2.4.2 (Confirm Return), 2.5.1 (Penalty Type Management)

## Flowchart

```mermaid
flowchart TD
    Start([Reader logged in]) --> NavigatePenalty[Navigate to Penalty page]
    NavigatePenalty --> LoadPenalties[Load reader's penalties]
    LoadPenalties --> CheckPenalties{Penalties found?}
    
    CheckPenalties -->|No| ShowEmpty[Show 'Không có khoản phạt']
    CheckPenalties -->|Yes| DisplayPenalties[Display penalties:<br/>- Reason<br/>- Amount<br/>- Penalty Date<br/>- Status]
    
    DisplayPenalties --> ReaderAction{Reader action?}
    
    ReaderAction -->|View Details| ClickDetails[Click on penalty]
    ReaderAction -->|Filter by Status| SelectFilter[Select status filter]
    ReaderAction -->|Pay Penalty| ClickPay[Click 'Đã thanh toán'<br/>on unpaid penalty]
    
    ClickDetails --> ShowDetails[Show detailed penalty information]
    ShowDetails --> CloseDetails[Close details]
    CloseDetails --> DisplayPenalties
    
    SelectFilter --> ApplyFilter[Filter penalties by status]
    ApplyFilter --> UpdateDisplay[Update displayed list]
    UpdateDisplay --> DisplayPenalties
    
    SelectFilter --> ClearFilter[Clear filter]
    ClearFilter --> ResetDisplay[Reset to all penalties]
    ResetDisplay --> DisplayPenalties
    
    ClickPay --> CheckStatus{Penalty status?}
    
    CheckStatus -->|Not 'Chưa thanh toán'| ErrorStatus[Show error: Cannot pay this penalty<br/>Disable 'Đã thanh toán' button]
    ErrorStatus --> DisplayPenalties
    
    CheckStatus -->|'Chưa thanh toán'| ShowPaymentInfo[Show payment information]
    ShowPaymentInfo --> MakeTransfer[Reader makes bank transfer]
    MakeTransfer --> ConfirmPayment[Click 'Đã thanh toán']
    ConfirmPayment --> UpdateStatus[Update penalty status to 'Chờ xác nhận']
    UpdateStatus --> SavePayment{Save to database}
    
    SavePayment -->|Success| ShowSuccess[Show success message]
    SavePayment -->|Network Error| ErrorNetwork[Show network error, allow retry]
    ErrorNetwork --> ConfirmPayment
    
    ShowSuccess --> RefreshList[Refresh penalty list]
    RefreshList --> DisplayPenalties
    
    ClickPay --> CheckOwnership{Is reader's own penalty?}
    CheckOwnership -->|No| ErrorOwnership[Show error: Cannot pay other's penalty]
    ErrorOwnership --> DisplayPenalties
    CheckOwnership -->|Yes| ShowPaymentInfo
    
    LoadPenalties --> ErrorNetwork{Network error?}
    ErrorNetwork -->|Yes| ShowError[Show error message, allow retry]
    ShowError --> LoadPenalties
    
    style Start fill:#e1f5ff
    style DisplayPenalties fill:#c8e6c9
    style ShowSuccess fill:#c8e6c9
    style ShowEmpty fill:#fff9c4
    style ErrorStatus fill:#ffcdd2
    style ErrorOwnership fill:#ffcdd2
    style ErrorNetwork fill:#ffcdd2
    style ShowError fill:#ffcdd2
```

## Validation Rules
- Penalty must be in "Chưa thanh toán" status to be paid
- Only reader's own penalties can be paid

## Error Cases
- No penalties found
- Penalty already paid
- Not reader's own penalty
- Network error

## Note
- Reader makes bank transfer payment, then marks as paid
- Status changes to "Chờ xác nhận" waiting for librarian confirmation

